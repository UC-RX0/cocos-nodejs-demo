{"version":3,"sources":["file:///D:/CocosProject/cocos-nodejs-io-game-start-demo-master/apps/client/extensions/Behavior%20Eden/src/runtime/core/BehaviorTree.ts"],"names":["_decorator","Component","JsonAsset","Node","director","CCBoolean","NodeStatus","BehaviorEditor","BehaviorManager","BehaviorSource","ccclass","property","requireComponent","BehaviorTreeEvent","BehaviorTree","isPaused","isInit","behaviorSource","map","Map","status","Inactive","onLoad","parse","asset","json","enableBehavior","createBehaviorManager","instance","disableBehavior","pause","pauseWhenDisabled","start","startWhenEnabled","onEnable","onDisable","node","addComponent","getScene","addChild","on","event","cb","ctx","has","get","push","set","off","index","findIndex","i","splice","emit","params","forEach","apply","clear","getAssetUrl","uuid","_uuid","url","Editor","Message","request"],"mappings":"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","sourcesContent":["import { _decorator, Component, JsonAsset, Node, director, CCBoolean } from \"cc\";\r\nimport { NodeStatus } from \"../node\";\r\nimport { BehaviorEditor } from \"./BehaviorEditor\";\r\nimport { BehaviorManager } from \"./BehaviorManager\";\r\nimport { BehaviorSource } from \"./BehaviorSource\";\r\n\r\nconst { ccclass, property, requireComponent } = _decorator;\r\n\r\ninterface IItem {\r\n  cb: Function;\r\n  ctx: unknown;\r\n}\r\n\r\nexport enum BehaviorTreeEvent {\r\n  BehaviorTreeStart,\r\n  BehaviorTreeEnd,\r\n}\r\n\r\n/***\r\n * 用户真正使用的组件，用来设置单个行为树的运行参数\r\n */\r\n@ccclass(\"BehaviorTree\")\r\n@requireComponent(BehaviorEditor)\r\nexport class BehaviorTree extends Component {\r\n  @property(JsonAsset)\r\n  asset: JsonAsset = null!;\r\n\r\n  @property(CCBoolean)\r\n  restartWhenComplete = false;\r\n\r\n  @property(CCBoolean)\r\n  startWhenEnabled = true;\r\n\r\n  /***\r\n   * true：节点失活的时候，行为树会保留，仅暂停运行\r\n   * false：节点失活的时候，行为树直接删除\r\n   */\r\n  @property(CCBoolean)\r\n  pauseWhenDisabled = false;\r\n\r\n  @property(CCBoolean)\r\n  logNodeChange = false;\r\n\r\n  // 是否被暂停运行了（未开始执行的行为树或者被删除的树都不属于暂停）\r\n  isPaused = false;\r\n\r\n  // 是否执行完start生成周期，防止start和onEnable重复执行enableBehavior\r\n  isInit = false;\r\n\r\n  behaviorSource: BehaviorSource = new BehaviorSource();\r\n\r\n  private map: Map<BehaviorTreeEvent, Array<IItem>> = new Map();\r\n\r\n  // 当前行为树状态\r\n  status: NodeStatus = NodeStatus.Inactive;\r\n\r\n  onLoad() {\r\n    // 解析json文件\r\n    this.behaviorSource.parse(this.asset.json);\r\n  }\r\n\r\n  /***\r\n   * 仅enableBehavior和disableBehavior属于供用户在自定义脚本中管理单个行为树的方法\r\n   * 其他方法请勿使用\r\n   */\r\n  enableBehavior() {\r\n    this.createBehaviorManager();\r\n    if (BehaviorManager.instance) {\r\n      BehaviorManager.instance.enableBehavior(this);\r\n    }\r\n  }\r\n\r\n  disableBehavior(pause = this.pauseWhenDisabled) {\r\n    if (BehaviorManager.instance) {\r\n      BehaviorManager.instance.disableBehavior(this, pause);\r\n      this.isPaused = pause;\r\n    }\r\n  }\r\n\r\n  start() {\r\n    if (this.startWhenEnabled) {\r\n      this.enableBehavior();\r\n    }\r\n    this.isInit = true;\r\n  }\r\n\r\n  onEnable() {\r\n    if (!this.isInit) {\r\n      return;\r\n    }\r\n\r\n    // 运行被暂停或者startWhenEnabled的树\r\n    if (this.isPaused || this.startWhenEnabled) {\r\n      this.enableBehavior();\r\n      this.isPaused = false;\r\n    }\r\n  }\r\n\r\n  onDisable() {\r\n    this.disableBehavior();\r\n  }\r\n\r\n  createBehaviorManager() {\r\n    if (!BehaviorManager.instance) {\r\n      const node = new Node(\"BehaviorManager\");\r\n      BehaviorManager.instance = node.addComponent(BehaviorManager);\r\n      director.getScene()!.addChild(node);\r\n    }\r\n  }\r\n\r\n  /***\r\n   * 发布订阅\r\n   */\r\n  on(event: BehaviorTreeEvent, cb: Function, ctx: unknown) {\r\n    if (this.map.has(event)) {\r\n      this.map.get(event)!.push({ cb, ctx });\r\n    } else {\r\n      this.map.set(event, [{ cb, ctx }]);\r\n    }\r\n  }\r\n\r\n  off(event: BehaviorTreeEvent, cb: Function, ctx: unknown) {\r\n    if (this.map.has(event)) {\r\n      const index = this.map.get(event)!.findIndex((i) => cb === i.cb && i.ctx === ctx);\r\n      index > -1 && this.map.get(event)!.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  emit(event: BehaviorTreeEvent, ...params: unknown[]) {\r\n    if (this.map.has(event)) {\r\n      this.map.get(event)!.forEach(({ cb, ctx }) => {\r\n        cb.apply(ctx, params);\r\n      });\r\n    }\r\n  }\r\n\r\n  clear() {\r\n    this.map.clear();\r\n  }\r\n\r\n  /***\r\n   * 插件面板初始化时调用\r\n   */\r\n  async getAssetUrl() {\r\n    if (!this.asset) {\r\n      return;\r\n    }\r\n    const uuid = this.asset._uuid;\r\n    // 获取当前json的url\r\n    const url = await Editor.Message.request(\"asset-db\", \"query-url\", uuid);\r\n    return url;\r\n  }\r\n}\r\n"]}