{"version":3,"sources":["file:///D:/CocosProject/cocos-nodejs-io-game-start-demo-master/apps/client/assets/Scripts/Global/DataManager.ts"],"names":["DataManager","Singleton","InputTypeEnum","EventManager","EventEnum","MOVE_SPEED","BULLET_SPEED","MAP_WIDTH","MAP_HEIGHT","PLAYER_RADIUS","BULLET_RADIUS","ATTACK","MAX_HP","frameID","roomInfo","lasteState","_stage","_actorMap","Map","_prefabMap","_textureMap","_bulletMap","playerID","_jm","state","actor","bullets","nextBulletID","Instance","GetInstance","bulletMap","setBulletManager","key","value","set","stage","textureMap","setTextureMap","prefabMap","setprefabMap","jm","actorMap","setActorManager","id","applyInput","input","type","ActorMove","direction","x","y","dt","find","v","length","Math","sqrt","position","WeaponShoot","owner","dx","dy","bullet","bulletType","get","emit","BulletBorn","push","TimePast","distance","splice","indexOf","ExplosionBorn","hp","abs"],"mappings":";;;kIAqBqBA,W;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAnBdC,MAAAA,S;;AACoDC,MAAAA,a,iBAAAA,a;;AAIpDC,MAAAA,Y;;AACEC,MAAAA,S,iBAAAA,S;;;;;;;;;AAEHC,MAAAA,U,GAAa,G;AACbC,MAAAA,Y,GAAe,G;AAEfC,MAAAA,S,GAAY,G;AACZC,MAAAA,U,GAAa,G;AAEbC,MAAAA,a,GAAgB,E;AAChBC,MAAAA,a,GAAgB,E;AAEhBC,MAAAA,M,GAAS,C;;wBACFC,M,GAAS,G;;yBACDZ,W,GAAN,MAAMA,WAAN;AAAA;AAAA,kCAAoC;AAAA;AAAA;AAAA,eAKjDa,OALiD,GAK/B,CAL+B;AAAA,eAMjDC,QANiD;AAAA,eAOjDC,UAPiD;AAAA,eAQzCC,MARyC,GAQ1B,IAR0B;AAAA,eASzCC,SATyC,GASF,IAAIC,GAAJ,EATE;AASQ;AATR,eAUzCC,UAVyC,GAUP,IAAID,GAAJ,EAVO;AAUG;AAVH,eAWzCE,WAXyC,GAWC,IAAIF,GAAJ,EAXD;AAWW;AAXX,eAYzCG,UAZyC,GAYA,IAAIH,GAAJ,EAZA;AAYU;AAZV,eAajDI,QAbiD,GAa9B,CAb8B;AAAA,eAsCzCC,GAtCyC;AAmDjD;AAnDiD,eAoDjDC,KApDiD,GAoDjC;AACdC,YAAAA,KAAK,EAAE,CACL;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAlBK,aADO;AAqBdC,YAAAA,OAAO,EAAE,EArBK;AAsBdC,YAAAA,YAAY,EAAE;AAtBA,WApDiC;AAAA;;AAE9B,mBAARC,QAAQ,GAAG;AACpB,iBAAO,MAAMC,WAAN,EAAP;AACD;;AASoB;AACD,YAATC,SAAS,GAA+B;AACjD,iBAAO,KAAKT,UAAZ;AACD;;AACMU,QAAAA,gBAAgB,CAACC,GAAD,EAAcC,KAAd,EAAoC;AACzD,eAAKZ,UAAL,CAAgBa,GAAhB,CAAoBF,GAApB,EAAyBC,KAAzB;AACD;;AACe,YAALE,KAAK,GAAS;AACvB,iBAAO,KAAKnB,MAAZ;AACD;;AACe,YAALmB,KAAK,CAACF,KAAD,EAAc;AAC5B,eAAKjB,MAAL,GAAciB,KAAd;AACD;;AACoB,YAAVG,UAAU,GAA+B;AAClD,iBAAO,KAAKhB,WAAZ;AACD;;AACMiB,QAAAA,aAAa,CAACL,GAAD,EAAcC,KAAd,EAAoC;AACtD,eAAKb,WAAL,CAAiBc,GAAjB,CAAqBF,GAArB,EAA0BC,KAA1B;AACD;;AACmB,YAATK,SAAS,GAAwB;AAC1C,iBAAO,KAAKnB,UAAZ;AACD;;AACMoB,QAAAA,YAAY,CAACP,GAAD,EAAcC,KAAd,EAA6B;AAC9C,eAAKd,UAAL,CAAgBe,GAAhB,CAAoBF,GAApB,EAAyBC,KAAzB;AACD;;AAEY,YAAFO,EAAE,GAAoB;AAC/B,iBAAO,KAAKjB,GAAZ;AACD;;AACY,YAAFiB,EAAE,CAACP,KAAD,EAAyB;AACpC,eAAKV,GAAL,GAAWU,KAAX;AACD;;AACkB,YAARQ,QAAQ,GAA8B;AAC/C,iBAAO,KAAKxB,SAAZ;AACD;;AACMyB,QAAAA,eAAe,CAACC,EAAD,EAAalB,KAAb,EAAkC;AACtD,eAAKR,SAAL,CAAeiB,GAAf,CAAmBS,EAAnB,EAAuBlB,KAAvB;AACD;;AA0BD;AACF;AACA;AACA;AACEmB,QAAAA,UAAU,CAACC,KAAD,EAAqB;AAC7B,kBAAQA,KAAK,CAACC,IAAd;AACE,iBAAK;AAAA;AAAA,gDAAcC,SAAnB;AAA8B;AAC5B,sBAAM;AACJJ,kBAAAA,EADI;AAEJK,kBAAAA,SAAS,EAAE;AAAEC,oBAAAA,CAAF;AAAKC,oBAAAA;AAAL,mBAFP;AAGJC,kBAAAA;AAHI,oBAIFN,KAJJ,CAD4B,CAM5B;;AACA,sBAAMpB,KAAK,GAAG,KAAKD,KAAL,CAAWC,KAAX,CAAiB2B,IAAjB,CAAsBC,CAAC,IAAIA,CAAC,CAACV,EAAF,KAASA,EAApC,CAAd;;AACA,oBAAIlB,KAAJ,EAAW;AACTA,kBAAAA,KAAK,CAACuB,SAAN,CAAgBC,CAAhB,GAAoBA,CAApB;AACAxB,kBAAAA,KAAK,CAACuB,SAAN,CAAgBE,CAAhB,GAAoBA,CAApB;AACA,wBAAMI,MAAM,GAAGC,IAAI,CAACC,IAAL,CAAUP,CAAC,GAAGA,CAAJ,GAAQC,CAAC,GAAGA,CAAtB,CAAf;;AACA,sBAAII,MAAM,GAAG,CAAb,EAAgB;AACd7B,oBAAAA,KAAK,CAACgC,QAAN,CAAeR,CAAf,IAAqBA,CAAC,GAAGK,MAAL,GAAejD,UAAf,GAA4B8C,EAAhD;AACA1B,oBAAAA,KAAK,CAACgC,QAAN,CAAeP,CAAf,IAAqBA,CAAC,GAAGI,MAAL,GAAejD,UAAf,GAA4B8C,EAAhD;AACD;AACF;;AACD;AACD;;AACD,iBAAK;AAAA;AAAA,gDAAcO,WAAnB;AAAgC;AAAA;;AAE9B,sBAAM;AAAEC,kBAAAA,KAAF;AAASF,kBAAAA,QAAQ,EAAE;AAAER,oBAAAA,CAAF;AAAKC,oBAAAA;AAAL,mBAAnB;AAA6BF,kBAAAA,SAAS,EAAE;AAAEC,oBAAAA,CAAC,EAAEW,EAAL;AAASV,oBAAAA,CAAC,EAAEW;AAAZ;AAAxC,oBAA6DhB,KAAnE;AACA,sBAAMiB,MAAe,GAAG;AACtBnB,kBAAAA,EAAE,EAAE,KAAKnB,KAAL,CAAWG,YAAX,EADkB;AAEtBgC,kBAAAA,KAFsB;AAGtBF,kBAAAA,QAAQ,EAAE;AAAER,oBAAAA,CAAF;AAAKC,oBAAAA;AAAL,mBAHY;AAItBF,kBAAAA,SAAS,EAAE;AAAEC,oBAAAA,CAAC,EAAEW,EAAL;AAASV,oBAAAA,CAAC,EAAEW;AAAZ,mBAJW;AAKtBE,kBAAAA,UAAU,wBAAE,KAAKtB,QAAL,CAAcuB,GAAd,CAAkBL,KAAlB,CAAF,qBAAE,mBAA0BI;AALhB,iBAAxB;AAOA;AAAA;AAAA,kDAAanC,QAAb,CAAsBqC,IAAtB,CAA2B;AAAA;AAAA,4CAAUC,UAArC,EAAiDP,KAAjD;AACA,qBAAKnC,KAAL,CAAWE,OAAX,CAAmByC,IAAnB,CAAwBL,MAAxB;AACA;AACD;;AACD,iBAAK;AAAA;AAAA,gDAAcM,QAAnB;AAA6B;AAC3B,sBAAM;AAAEjB,kBAAAA;AAAF,oBAASN,KAAf;;AAEA,qBAAK,MAAMiB,MAAX,IAAqB,KAAKtC,KAAL,CAAWE,OAAhC,EAAyC;AACvCoC,kBAAAA,MAAM,CAACL,QAAP,CAAgBR,CAAhB,IAAqBa,MAAM,CAACd,SAAP,CAAiBC,CAAjB,GAAqB3C,YAArB,GAAoC6C,EAAzD;AACAW,kBAAAA,MAAM,CAACL,QAAP,CAAgBP,CAAhB,IAAqBY,MAAM,CAACd,SAAP,CAAiBE,CAAjB,GAAqB5C,YAArB,GAAoC6C,EAAzD,CAFuC,CAGvC;AACA;;AACA,uBAAK,MAAM1B,KAAX,IAAoB,KAAKD,KAAL,CAAWC,KAA/B,EAAsC;AACpC,wBAAIA,KAAK,CAACkB,EAAN,KAAamB,MAAM,CAACH,KAAxB,EAA+B,SADK,CACK;;AACzC,0BAAMU,QAAQ,GAAGd,IAAI,CAACC,IAAL,CAAU,CAACM,MAAM,CAACL,QAAP,CAAgBR,CAAhB,GAAoBxB,KAAK,CAACgC,QAAN,CAAeR,CAApC,KAA0C,CAA1C,GAA8C,CAACa,MAAM,CAACL,QAAP,CAAgBP,CAAhB,GAAoBzB,KAAK,CAACgC,QAAN,CAAeP,CAApC,KAA0C,CAAlG,CAAjB;;AACA,wBAAImB,QAAQ,GAAG5D,aAAa,GAAGC,aAA/B,EAA8C;AAC5C;AACA,2BAAKc,KAAL,CAAWE,OAAX,CAAmB4C,MAAnB,CAA0B,KAAK9C,KAAL,CAAWE,OAAX,CAAmB6C,OAAnB,CAA2BT,MAA3B,CAA1B,EAA8D,CAA9D;AACA;AAAA;AAAA,wDAAalC,QAAb,CAAsBqC,IAAtB,CAA2B;AAAA;AAAA,kDAAUO,aAArC,EAAoDV,MAAM,CAACnB,EAA3D,EAA+D;AAAEM,wBAAAA,CAAC,EAAEa,MAAM,CAACL,QAAP,CAAgBR,CAArB;AAAwBC,wBAAAA,CAAC,EAAEY,MAAM,CAACL,QAAP,CAAgBP;AAA3C,uBAA/D;AACAzB,sBAAAA,KAAK,CAACgD,EAAN,IAAY9D,MAAZ,CAJ4C,CAIzB;;AACnB;AACD;AACF,mBAfsC,CAgBvC;;;AACA,sBAAI4C,IAAI,CAACmB,GAAL,CAASZ,MAAM,CAACL,QAAP,CAAgBR,CAAzB,IAA8B1C,SAAS,GAAG,CAA1C,IAA+CgD,IAAI,CAACmB,GAAL,CAASZ,MAAM,CAACL,QAAP,CAAgBP,CAAzB,IAA8B1C,UAAU,GAAG,CAA9F,EAAiG;AAC/F,yBAAKgB,KAAL,CAAWE,OAAX,CAAmB4C,MAAnB,CAA0B,KAAK9C,KAAL,CAAWE,OAAX,CAAmB6C,OAAnB,CAA2BT,MAA3B,CAA1B,EAA8D,CAA9D;AACA;AAAA;AAAA,sDAAalC,QAAb,CAAsBqC,IAAtB,CAA2B;AAAA;AAAA,gDAAUO,aAArC,EAAoDV,MAAM,CAACnB,EAA3D,EAA+D;AAAEM,sBAAAA,CAAC,EAAEa,MAAM,CAACL,QAAP,CAAgBR,CAArB;AAAwBC,sBAAAA,CAAC,EAAEY,MAAM,CAACL,QAAP,CAAgBP;AAA3C,qBAA/D;AACD;AACF;AACF;;AACD;AACE;AA7DJ;AA+DD;;AAhJgD,O;;AAA9BlD,MAAAA,W,CACZA,W","sourcesContent":["import { input, director, Prefab, SpriteFrame, Node } from 'cc';\n\nimport Singleton from \"../Base/Singleton\";\nimport { clientInput, EntityTypeEnum, IActorMove, IBullet, InputTypeEnum, Iroom, Istate } from \"../Common\";\nimport { JoyStickManager } from '../UI/JoyStickManager';\nimport { ActorManager } from '../Entity/Actor/ActorManager';\nimport { BulletManager } from '../Entity/Bullet/BulletManager';\nimport EventManager from './EventManager';\nimport { EventEnum } from '../Enum';\n\nconst MOVE_SPEED = 150;\nconst BULLET_SPEED = 600;\n\nconst MAP_WIDTH = 960;\nconst MAP_HEIGHT = 640;\n\nconst PLAYER_RADIUS = 60;\nconst BULLET_RADIUS = 10;\n\nconst ATTACK = 5\nexport const MAX_HP = 100;\nexport default class DataManager extends Singleton {\n  static DataManager: any;\n  static get Instance() {\n    return super.GetInstance<DataManager>();\n  }\n  frameID: number = 1;\n  roomInfo: Iroom;\n  lasteState: Istate\n  private _stage: Node = null;\n  private _actorMap: Map<number, ActorManager> = new Map();// key:actorID value:ActorManager实例\n  private _prefabMap: Map<string, Prefab> = new Map();// key:资源路径 value:Prefab实例\n  private _textureMap: Map<string, SpriteFrame[]> = new Map();// key:资源路径 value:SpriteFrame实例数组\n  private _bulletMap: Map<number, BulletManager> = new Map();// key:bulletID value:BulletManager实例\n  playerID: number = 1;//当前玩家ID\n  public get bulletMap(): Map<number, BulletManager> {\n    return this._bulletMap;\n  }\n  public setBulletManager(key: number, value: BulletManager) {\n    this._bulletMap.set(key, value);\n  }\n  public get stage(): Node {\n    return this._stage;\n  }\n  public set stage(value: Node) {\n    this._stage = value;\n  }\n  public get textureMap(): Map<string, SpriteFrame[]> {\n    return this._textureMap;\n  }\n  public setTextureMap(key: string, value: SpriteFrame[]) {\n    this._textureMap.set(key, value);\n  }\n  public get prefabMap(): Map<string, Prefab> {\n    return this._prefabMap;\n  }\n  public setprefabMap(key: string, value: Prefab) {\n    this._prefabMap.set(key, value);\n  }\n  private _jm: JoyStickManager;\n  public get jm(): JoyStickManager {\n    return this._jm;\n  }\n  public set jm(value: JoyStickManager) {\n    this._jm = value;\n  }\n  public get actorMap(): Map<number, ActorManager> {\n    return this._actorMap;\n  }\n  public setActorManager(id: number, actor: ActorManager) {\n    this._actorMap.set(id, actor);\n  }\n  //记录当前游戏中的所有玩家信息\n  state: Istate = {\n    actor: [\n      // {\n      //   id: 1,\n      //   position: { x: -150, y: -150 },\n      //   direction: { x: 1, y: 0 },\n      //   Type: EntityTypeEnum.Actor1,\n      //   weaponType: EntityTypeEnum.Weapon1,\n      //   bulletType: EntityTypeEnum.Bullet2,\n      //   hp: 100\n      // },\n      // {\n      //   id: 2,\n      //   position: { x: 150, y: 150 },\n      //   direction: { x: -1, y: 0 },\n      //   Type: EntityTypeEnum.Actor1,\n      //   weaponType: EntityTypeEnum.Weapon1,\n      //   bulletType: EntityTypeEnum.Bullet2,\n      //   hp: 100\n      // },\n    ],\n    bullets: [],\n    nextBulletID: 1,\n  }\n  /**\n   * @description \n   * @param input \n   */\n  applyInput(input: clientInput) {\n    switch (input.type) {\n      case InputTypeEnum.ActorMove: {\n        const {\n          id,\n          direction: { x, y },\n          dt\n        } = input\n        //找到包里的需要修改的玩家ID 然后修改位置和方向\n        const actor = this.state.actor.find(v => v.id === id);\n        if (actor) {\n          actor.direction.x = x;\n          actor.direction.y = y;\n          const length = Math.sqrt(x * x + y * y);\n          if (length > 0) {\n            actor.position.x += (x / length) * MOVE_SPEED * dt;\n            actor.position.y += (y / length) * MOVE_SPEED * dt;\n          }\n        }\n        break;\n      }\n      case InputTypeEnum.WeaponShoot: {\n\n        const { owner, position: { x, y }, direction: { x: dx, y: dy } } = input\n        const bullet: IBullet = {\n          id: this.state.nextBulletID++,\n          owner,\n          position: { x, y },\n          direction: { x: dx, y: dy },\n          bulletType: this.actorMap.get(owner)?.bulletType,\n        }\n        EventManager.Instance.emit(EventEnum.BulletBorn, owner);\n        this.state.bullets.push(bullet);\n        break;\n      }\n      case InputTypeEnum.TimePast: {\n        const { dt } = input;\n\n        for (const bullet of this.state.bullets) {\n          bullet.position.x += bullet.direction.x * BULLET_SPEED * dt;\n          bullet.position.y += bullet.direction.y * BULLET_SPEED * dt;\n          //碰撞检测 子弹是否有与物体接触\n          // 遍历所有玩家 检查是否与玩家碰撞\n          for (const actor of this.state.actor) {\n            if (actor.id === bullet.owner) continue; // 跳过自己\n            const distance = Math.sqrt((bullet.position.x - actor.position.x) ** 2 + (bullet.position.y - actor.position.y) ** 2);\n            if (distance < PLAYER_RADIUS + BULLET_RADIUS) {\n              // 碰撞检测成功 销毁子弹 激活爆炸特效 TODO玩家扣血功能\n              this.state.bullets.splice(this.state.bullets.indexOf(bullet), 1);\n              EventManager.Instance.emit(EventEnum.ExplosionBorn, bullet.id, { x: bullet.position.x, y: bullet.position.y });\n              actor.hp -= ATTACK;//玩家扣血 计算公式要*一个攻击系数\n              break;\n            }\n          }\n          //判断是否超出地图边界 超出则销毁 \n          if (Math.abs(bullet.position.x) > MAP_WIDTH / 2 || Math.abs(bullet.position.y) > MAP_HEIGHT / 2) {\n            this.state.bullets.splice(this.state.bullets.indexOf(bullet), 1);\n            EventManager.Instance.emit(EventEnum.ExplosionBorn, bullet.id, { x: bullet.position.x, y: bullet.position.y });\n          }\n        }\n      }\n      default:\n        break;\n    }\n  }\n\n}\n"]}