{"version":3,"sources":["file:///D:/CocosProject/cocos-nodejs-io-game-start-demo-master/apps/client/assets/Scripts/Entity/Bullet/BulletManager.ts"],"names":["_decorator","Vec3","Tween","ExplosionManager","DataManager","EntityTypeEnum","EntityManager","EntityStateEnum","EventEnum","rad2Angle","BulletStateMachine","EventManager","ObjectPoolManager","ccclass","property","BulletManager","bulletType","id","targetPos","undefined","tw","init","data","fsm","addComponent","state","Idle","node","active","Instance","on","ExplosionBorn","handleExplosionBorn","x","y","explosion","get","Explosion","em","getComponent","bulletMap","delete","off","ret","tick","dt","render","renderPos","renderAngle","position","newPos","setPosition","equals","stop","set","to","start","direction","side","Math","sign","angle","asin","setRotationFromEuler"],"mappings":"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","sourcesContent":["\r\nimport { ExplosionManager } from './../Explosion/ExplosionManager';\r\nimport { buildTree } from './../../../../extensions/Behavior Eden/src/runtime/core/utils';\r\nimport { _decorator, instantiate, IVec2, input, Vec3, Tween, Node } from 'cc';\r\nimport DataManager from '../../Global/DataManager';\r\nimport { EntityTypeEnum, IActor, IBullet, InputTypeEnum } from '../../Common';\r\nimport { EntityManager } from '../../Base/EntityManager';\r\n\r\nimport { EntityStateEnum, EventEnum, PrefabPathEnum } from '../../Enum';\r\nimport { WeaponManager } from '../Weapon/WeaponManager';\r\nimport { rad2Angle } from '../../Utils';\r\nimport { BulletStateMachine } from './BulletStateMachine';\r\nimport EventManager from '../../Global/EventManager';\r\nimport ObjectPoolManager from '../../Global/ObjectPoolManager';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('BulletManager')\r\n/** \r\n * @description 子弹管理器 \r\n * \r\n*/\r\nexport class BulletManager extends EntityManager {\r\n    bulletType: EntityTypeEnum\r\n    id: number\r\n    private targetPos: Vec3 = undefined\r\n    private tw: Tween<Node>;\r\n    /**\r\n     * @description 初始化玩家信息\r\n     * @param data \r\n     */\r\n    init(data: IBullet) {\r\n        this.bulletType = data.bulletType;\r\n        this.id = data.id;\r\n        this.fsm = this.addComponent(BulletStateMachine);//添加状态机组件 多态\r\n        this.fsm.init(data.bulletType);//初始化状态机\r\n        this.state = EntityStateEnum.Idle;//设置初始状态\r\n        this.node.active = false\r\n        EventManager.Instance.on(EventEnum.ExplosionBorn, this.handleExplosionBorn, this);\r\n    }\r\n    handleExplosionBorn(id: number, { x, y }: IVec2) {\r\n        if (id !== this.id) return; //确定子弹的ID是唯一的 逻辑上是 如果前面的子弹不销毁时 后续子弹不会对未销毁的子弹有影响 确保唯一性\r\n        const explosion = ObjectPoolManager.Instance.get(EntityTypeEnum.Explosion)\r\n        const em = explosion.getComponent(ExplosionManager) || explosion.addComponent(ExplosionManager)\r\n        em.init(EntityTypeEnum.Explosion, { x, y })\r\n        DataManager.Instance.bulletMap.delete(this.id);\r\n        EventManager.Instance.off(EventEnum.ExplosionBorn, this.handleExplosionBorn, this)\r\n        ObjectPoolManager.Instance.ret(this.node)\r\n    }\r\n\r\n\r\n    tick(dt): void {\r\n        //todo\r\n    }\r\n    /**\r\n     * @description 渲染子弹信息\r\n     * @param data \r\n     */\r\n    render(data: IBullet) {\r\n        this.renderPos(data)\r\n        this.renderAngle(data)\r\n\r\n    }\r\n    renderPos(data: IBullet) {\r\n        const { position } = data\r\n        const newPos = new Vec3(position.x, position.y);\r\n        if (!this.targetPos) {\r\n            this.node.active = true;\r\n            this.node.setPosition(newPos);\r\n            this.targetPos = new Vec3(newPos);\r\n        } else if (!this.targetPos.equals(newPos)) {\r\n            this.tw?.stop();\r\n            this.node.setPosition(this.targetPos);\r\n            this.targetPos.set(newPos);\r\n            this.tw = new Tween(this.node)\r\n                .to(0.1, { position: this.targetPos })\r\n                .start();\r\n        }\r\n    }\r\n    renderAngle(data: IBullet) {\r\n        const { direction } = data\r\n        const side = Math.sign(direction.x ** 2 + direction.y ** 2);\r\n        const angle = direction.x > 0 ? rad2Angle(Math.asin(direction.y / side)) : rad2Angle(Math.asin(-direction.y / side)) + 180;\r\n        this.node.setRotationFromEuler(0, 0, angle);\r\n    }\r\n}\r\n\r\n\r\n"]}