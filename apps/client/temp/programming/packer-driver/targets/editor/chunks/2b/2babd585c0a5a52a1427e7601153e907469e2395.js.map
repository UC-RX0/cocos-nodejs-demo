{"version":3,"sources":["file:///D:/CocosProject/cocos-nodejs-io-game-start-demo-master/apps/client/assets/Scripts/Entity/Actor/ActorManager.ts"],"names":["_decorator","instantiate","ProgressBar","Tween","Vec3","DataManager","MAX_HP","EntityTypeEnum","InputTypeEnum","EntityManager","ActorStateMachine","EntityStateEnum","EventEnum","WeaponManager","rad2Angle","EventManager","ccclass","property","ActorManager","wm","bulletType","id","hpBar","targetPos","undefined","tw","init","data","node","active","fsm","addComponent","Type","state","Idle","getChildByName","getComponent","weaponPrefab","Instance","prefabMap","get","Weapon1","weaponNode","parent","setPosition","tick","dt","playerID","x","y","jm","input","length","emit","ClientSync","type","ActorMove","direction","render","renderPosition","renderAngle","renderHp","position","newPos","equals","stop","set","Run","to","call","start","setScale","side","Math","sign","angle","asin","setRotationFromEuler","progress","hp","actorMap","delete","actor","splice","findIndex","a","destroy"],"mappings":"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","sourcesContent":["import { buildTree } from './../../../../extensions/Behavior Eden/src/runtime/core/utils';\r\nimport { _decorator, instantiate, Node, ProgressBar, Sprite, Color, Tween, Vec3 } from 'cc';\r\nimport DataManager, { MAX_HP } from '../../Global/DataManager';\r\nimport { EntityTypeEnum, IActor, InputTypeEnum, toFix } from '../../Common';\r\nimport { EntityManager } from '../../Base/EntityManager';\r\nimport { ActorStateMachine } from './ActorStateMachine';\r\nimport { EntityStateEnum, EventEnum, PrefabPathEnum } from '../../Enum';\r\nimport { WeaponManager } from '../Weapon/WeaponManager';\r\nimport { rad2Angle } from '../../Utils';\r\nimport EventManager from '../../Global/EventManager';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('ActorManager')\r\n/** \r\n * @description 玩家管理器 \r\n * \r\n*/\r\nexport class ActorManager extends EntityManager {\r\n    private wm: WeaponManager\r\n    bulletType: EntityTypeEnum\r\n    private id: number\r\n    private hpBar: ProgressBar\r\n    private targetPos: Vec3 = undefined\r\n    private tw: Tween<Node>;\r\n    /**\r\n     * @description 初始化玩家信息\r\n     * @param data \r\n     */\r\n    init(data: IActor) {\r\n        this.node.active = false;\r\n        this.id = data.id;\r\n        this.bulletType = data.bulletType;\r\n        this.fsm = this.addComponent(ActorStateMachine);//添加状态机组件 多态\r\n        this.fsm.init(data.Type);//初始化状态机\r\n        this.state = EntityStateEnum.Idle;//设置初始状态\r\n        this.hpBar = this.node.getChildByName('Hp').getComponent(ProgressBar);\r\n        const weaponPrefab = DataManager.Instance.prefabMap.get(EntityTypeEnum.Weapon1);\r\n        if (weaponPrefab) {\r\n            const weaponNode = instantiate(weaponPrefab);\r\n            weaponNode.parent = this.node;\r\n            weaponNode.setPosition(0, 0);\r\n            this.wm = weaponNode.addComponent(WeaponManager);\r\n            this.wm.init(data);\r\n        }\r\n    }\r\n\r\n    tick(dt): void {\r\n        if (this.id !== DataManager.Instance.playerID) return;//不是当前玩家 不处理\r\n        const { x, y } = DataManager.Instance.jm.input;\r\n\r\n        if (DataManager.Instance.jm.input.length()) {\r\n            EventManager.Instance.emit(EventEnum.ClientSync, {\r\n                id: DataManager.Instance.playerID,\r\n                type: InputTypeEnum.ActorMove,\r\n                direction: {\r\n                    x: x,\r\n                    y: y\r\n                },\r\n                dt\r\n            })\r\n\r\n        } else {\r\n            this.state = EntityStateEnum.Idle;\r\n        }\r\n    }\r\n    /**\r\n     * @description 渲染玩家信息\r\n     * @param data \r\n     */\r\n    render(data: IActor) {\r\n        this.renderPosition(data);\r\n        this.renderAngle(data);\r\n        this.renderHp(data);\r\n    }\r\n    renderPosition(data: IActor) {\r\n        const { position } = data\r\n        const newPos = new Vec3(position.x, position.y);\r\n        if (!this.targetPos) {\r\n            this.node.active = true;\r\n            this.node.setPosition(newPos);\r\n            this.targetPos = new Vec3(newPos);\r\n        } else if (!this.targetPos.equals(newPos)) {\r\n            this.tw?.stop();\r\n            this.node.setPosition(this.targetPos);\r\n            this.targetPos.set(newPos);\r\n            this.state = EntityStateEnum.Run;\r\n            this.tw = new Tween(this.node)\r\n                .to(0.1, { position: this.targetPos })\r\n                .call(() => {\r\n                    this.state = EntityStateEnum.Idle;\r\n                })\r\n                .start();\r\n        }\r\n    }\r\n    renderAngle(data: IActor) {\r\n        const { direction } = data\r\n        if (direction.x !== 0) {\r\n            this.node.setScale(direction.x > 0 ? 1 : -1, 1);\r\n            this.hpBar.node.setScale(direction.x > 0 ? 1 : -1, 1);\r\n        }\r\n        const side = Math.sign(direction.x ** 2 + direction.y ** 2);\r\n        const angle = rad2Angle(Math.asin(direction.y / side));\r\n        this.wm.node.setRotationFromEuler(0, 0, angle);\r\n    }\r\n    renderHp(data: IActor) {\r\n        this.hpBar.progress = data.hp / MAX_HP;\r\n        if (data.hp <= 0) {\r\n            DataManager.Instance.actorMap.delete(this.id);\r\n            DataManager.Instance.state.actor.splice(DataManager.Instance.state.actor.findIndex(a => a.id === this.id), 1);\r\n            this.node.destroy();\r\n        }\r\n    }\r\n}\r\n\r\n\r\n"]}