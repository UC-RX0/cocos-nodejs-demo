{"version":3,"sources":["file:///D:/CocosProject/cocos-nodejs-io-game-start-demo-master/apps/client/extensions/Behavior%20Eden/src/runtime/core/BehaviorSource.ts"],"names":["BehaviorSource","Composite","nodeClsMap","buildTree","postOrder","rootNode","parse","content","nodes","length","Error","nodesMap","Map","node","set","id","root","postOrderNodes","nodeIdInstanceMap","i","cls","get","type","instance","nodeData","data","abortType","children","map","child","setChildren","e","console","error"],"mappings":";;;8DAOaA,c;;;;;;;;AAPJC,MAAAA,S,gBAAAA,S;;AACAC,MAAAA,U,iBAAAA,U;;AACAC,MAAAA,S,iBAAAA,S;AAAWC,MAAAA,S,iBAAAA,S;;;;;AAEpB;AACA;AACA;gCACaJ,c,GAAN,MAAMA,cAAN,CAAqB;AAAA;AAAA,eAC1BK,QAD0B,GACF,IADE;AAAA;;AAG1BC,QAAAA,KAAK,CAACC,OAAY,GAAG,EAAhB,EAAoB;AAEvB,cAAI;AACF;AACA,gBAAG,KAAKF,QAAR,EAAiB;AACf;AACD;;AACD,kBAAMG,KAAK,GAAGD,OAAO,CAACC,KAAtB;;AACA,gBAAI,EAACA,KAAD,YAACA,KAAK,CAAEC,MAAR,CAAJ,EAAoB;AAClB,oBAAM,IAAIC,KAAJ,CAAU,SAAV,CAAN;AACD;;AACD,kBAAMC,QAA+B,GAAG,IAAIC,GAAJ,EAAxC;;AACA,iBAAK,MAAMC,IAAX,IAAmBL,KAAnB,EAA0B;AACxBG,cAAAA,QAAQ,CAACG,GAAT,CAAaD,IAAI,CAACE,EAAlB,EAAsBF,IAAtB;AACD;AAED;AACN;AACA;;;AACM,kBAAMG,IAAI,GAAGb,SAAS,CAACK,KAAD,CAAtB;;AACA,gBAAI,CAACQ,IAAL,EAAW;AACT,oBAAM,IAAIN,KAAJ,CAAU,QAAV,CAAN;AACD;AACD;AACN;AACA;;;AACM,kBAAMO,cAAc,GAAGb,SAAS,CAACY,IAAD,CAAhC,CAxBE,CAyBF;;AACA,kBAAME,iBAAiB,GAAG,IAAIN,GAAJ,EAA1B,CA1BE,CA2BF;;AACA,iBAAK,IAAIO,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGF,cAAc,CAACR,MAAnC,EAA2CU,CAAC,EAA5C,EAAgD;AAAA;;AAC9C,oBAAMN,IAAI,GAAGI,cAAc,CAACE,CAAD,CAA3B,CAD8C,CAE9C;;AACA,oBAAMC,GAAG,GAAGlB,UAAU,CAACmB,GAAX,CAAeR,IAAI,CAACS,IAApB,CAAZ;;AACA,kBAAI,CAACF,GAAL,EAAU;AACR,sBAAM,IAAIV,KAAJ,CAAU,YAAV,CAAN;AACD,eAN6C,CAO9C;;;AACA,oBAAMa,QAAQ,GAAG,IAAIH,GAAJ,EAAjB;AACA,oBAAMI,QAAQ,GAAGb,QAAQ,CAACU,GAAT,CAAaR,IAAI,CAACE,EAAlB,CAAjB,CAT8C,CAU9C;;AACAQ,cAAAA,QAAQ,CAACE,IAAT,GAAgBD,QAAhB,CAX8C,CAY9C;;AACA,kBAAID,QAAQ,YAAYtB,SAAxB,EAAmC;AACjCsB,gBAAAA,QAAQ,CAACG,SAAT,GAAqBF,QAAQ,CAACE,SAA9B;AACD,eAf6C,CAgB9C;;;AACA,oCAAIb,IAAI,CAACc,QAAT,aAAI,eAAelB,MAAnB,EAA2B;AACzB;AACA,sBAAMkB,QAAQ,GAAGd,IAAI,CAACc,QAAL,CAAcC,GAAd,CAAmBC,KAAD,IAAWX,iBAAiB,CAACG,GAAlB,CAAsBQ,KAAK,CAACd,EAA5B,CAA7B,CAAjB;AACCQ,gBAAAA,QAAD,CAAyBO,WAAzB,CAAqCH,QAArC;AACD;;AACDT,cAAAA,iBAAiB,CAACJ,GAAlB,CAAsBD,IAAI,CAACE,EAA3B,EAA+BQ,QAA/B,EAtB8C,CAuB9C;;AACA,kBAAIJ,CAAC,KAAKF,cAAc,CAACR,MAAf,GAAwB,CAAlC,EAAqC;AACnC,qBAAKJ,QAAL,GAAgBkB,QAAhB;AACD;AACF;AACF,WAxDD,CAwDE,OAAOQ,CAAP,EAAU;AACVC,YAAAA,OAAO,CAACC,KAAR,CAAcF,CAAd;AACD;AACF;;AAhEyB,O","sourcesContent":["import { Composite, Node, NodeData, ParentNode } from \"../node/index\";\r\nimport { nodeClsMap } from \"./decorator\";\r\nimport { buildTree, postOrder } from \"./utils\";\r\n\r\n/***\r\n * 主要用来解析json文件生成行为树对象\r\n */\r\nexport class BehaviorSource {\r\n  rootNode: Node | null = null;\r\n\r\n  parse(content: any = {}) {\r\n\r\n    try {\r\n      // root节点已存在，代表已经成功解析过\r\n      if(this.rootNode){\r\n        return\r\n      }\r\n      const nodes = content.nodes;\r\n      if (!nodes?.length) {\r\n        throw new Error(\"节点数据不存在\");\r\n      }\r\n      const nodesMap: Map<string, NodeData> = new Map();\r\n      for (const node of nodes) {\r\n        nodesMap.set(node.id, node);\r\n      }\r\n\r\n      /***\r\n       *  建树（数据层面）\r\n       */\r\n      const root = buildTree(nodes);\r\n      if (!root) {\r\n        throw new Error(\"根节点不存在\");\r\n      }\r\n      /***\r\n       *  建树（对象层面）\r\n       */\r\n      const postOrderNodes = postOrder(root);\r\n      // 节点id和对象的映射\r\n      const nodeIdInstanceMap = new Map();\r\n      // 倒序遍历\r\n      for (let i = 0; i < postOrderNodes.length; i++) {\r\n        const node = postOrderNodes[i];\r\n        // 获取节点对应的class\r\n        const cls = nodeClsMap.get(node.type) as any;\r\n        if (!cls) {\r\n          throw new Error(\"节点class不存在\");\r\n        }\r\n        // 实例化\r\n        const instance = new cls() as Node;\r\n        const nodeData = nodesMap.get(node.id)!;\r\n        // 保存node data\r\n        instance.data = nodeData;\r\n        // composite设置设置abortType\r\n        if (instance instanceof Composite) {\r\n          instance.abortType = nodeData.abortType;\r\n        }\r\n        // 父节点\r\n        if (node.children?.length) {\r\n          // 倒序遍历可以保证子节点的初始化在父节点之前\r\n          const children = node.children.map((child) => nodeIdInstanceMap.get(child.id));\r\n          (instance as ParentNode).setChildren(children);\r\n        }\r\n        nodeIdInstanceMap.set(node.id, instance);\r\n        // 最后一项是根节点\r\n        if (i === postOrderNodes.length - 1) {\r\n          this.rootNode = instance;\r\n        }\r\n      }\r\n    } catch (e) {\r\n      console.error(e);\r\n    }\r\n  }\r\n}\r\n"]}