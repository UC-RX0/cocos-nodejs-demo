{"version":3,"sources":["file:///D:/CocosProject/cocos-nodejs-io-game-start-demo-master/apps/client/assets/Scripts/Global/NetworkManager.ts"],"names":["NetworkManager","Singleton","port","socket","map","Map","inConnection","Instance","GetInstance","connect","Promise","resolve","reject","WebSocket","onopen","console","log","onclose","event","onerror","onmessage","name","data","JSON","parse","has","get","forEach","cb","ctx","call","error","callApi","time","setTimeout","success","Error","unListenMsg","rs","res","clearTimeout","listenMsg","sentMsg","msg","stringify","send","push","set","index","findIndex","i","splice"],"mappings":"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","sourcesContent":["import { _decorator, resources, Asset } from \"cc\";\r\nimport Singleton from \"../Base/Singleton\";\r\nimport { IModel } from \"../Common\";\r\n\r\ninterface IItem {\r\n    cb: Function;\r\n    ctx: unknown;\r\n}\r\ninterface IApiMsg<T> {\r\n    success: boolean;\r\n    res?: T;\r\n    error?: Error;\r\n}\r\nexport class NetworkManager extends Singleton {\r\n\r\n    static get Instance() {\r\n        return super.GetInstance<NetworkManager>();\r\n    }\r\n    port = 9876;\r\n    private socket: WebSocket;//统一通信管道\r\n    private map: Map<string, Array<IItem>> = new Map();\r\n    inConnection = false;\r\n    connect() {\r\n        return new Promise((resolve, reject) => {\r\n            if (this.inConnection) {\r\n                resolve(true)\r\n                return;\r\n            }\r\n            this.socket = new WebSocket(`ws://localhost:${this.port}`);\r\n            this.socket.onopen = () => {\r\n                this.inConnection = true;\r\n                console.log(\"连接成功\");\r\n                resolve(this.socket);\r\n            };\r\n            this.socket.onclose = (event) => {\r\n                this.inConnection = false;\r\n                console.log(\"连接关闭\", event);\r\n                reject(event);\r\n            };\r\n            this.socket.onerror = (event) => {\r\n                this.inConnection = false;\r\n                console.log(\"连接错误\", event);\r\n                reject(event);\r\n            };\r\n            this.socket.onmessage = (event) => {\r\n                try {\r\n                    // console.log(\"收到消息\", event.data);\r\n                    const { name, data } = JSON.parse(event.data);\r\n                    if (this.map.has(name)) {\r\n                        this.map.get(name).forEach(({ cb, ctx }) => {\r\n                            cb.call(ctx, data);\r\n                        });\r\n                    }\r\n                } catch (error) {\r\n                    console.log(\"解析消息错误\", error);\r\n                }\r\n\r\n            };\r\n        });\r\n    }\r\n    /**\r\n     * @description 调用接口\r\n     * @param name 接口名称\r\n     * @param data 接口参数\r\n     * @returns \r\n     */\r\n    callApi<T extends keyof IModel[\"api\"]>(name: T, data: IModel[\"api\"][T][\"req\"]): Promise<IApiMsg<IModel[\"api\"][T][\"res\"]>> {\r\n        return new Promise((resolve) => {\r\n            try {\r\n                const time = setTimeout(() => {\r\n                    resolve({ success: false, error: new Error(\"超时\") });\r\n                    this.unListenMsg(name as any, rs, null);\r\n                }, 5000);\r\n                const rs = (res) => {\r\n                    resolve(res);\r\n                    clearTimeout(time);\r\n                    this.unListenMsg(name as any, rs, null);\r\n                }\r\n                this.listenMsg(name as any, rs, null);\r\n                this.sentMsg(name as any, data);\r\n            } catch (error) {\r\n                resolve({ success: false, error });\r\n            }\r\n        });\r\n    }\r\n    sentMsg<T extends keyof IModel[\"msg\"]>(name: T, data: IModel[\"msg\"][T]) {\r\n        const msg = JSON.stringify({ name, data });\r\n        this.socket.send(msg);\r\n    }\r\n    listenMsg<T extends keyof IModel[\"msg\"]>(name: T, cb: (args: IModel[\"msg\"][T]) => void, ctx: unknown) {\r\n        if (this.map.has(name)) {\r\n            this.map.get(name).push({ cb, ctx });\r\n        } else {\r\n            this.map.set(name, [{ cb, ctx }]);\r\n        }\r\n    }\r\n    unListenMsg<T extends keyof IModel[\"msg\"]>(name: T, cb: (args: IModel[\"msg\"][T]) => void, ctx: unknown) {\r\n        if (this.map.has(name)) {\r\n            const index = this.map.get(name).findIndex((i) => cb === i.cb && i.ctx === ctx);\r\n            index > -1 && this.map.get(name).splice(index, 1);\r\n        }\r\n    }\r\n}\r\n"]}