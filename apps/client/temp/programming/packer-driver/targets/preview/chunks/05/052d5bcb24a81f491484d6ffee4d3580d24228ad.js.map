{"version":3,"sources":["file:///D:/CocosProject/cocos-nodejs-io-game-start-demo-master/apps/client/assets/Scripts/Scene/RoomManager.ts"],"names":["_decorator","Component","director","instantiate","Node","Prefab","NetworkManager","ApiMsgEnum","PlayerManager","DataManager","SceneEnum","deepClone","ccclass","property","RoomManager","onLoad","Instance","listenMsg","MsgRoomStart","handleStart","MsgRoom","renderPlayer","start","Room","roomInfo","onDestroy","unListenMsg","players","Players","c","PlayerList","children","active","length","PlayerPrefab","parent","i","data","node","getComponent","init","handleLeaveRoom","success","error","res","callApi","ApiRoomLeave","console","log","loadScene","Hall","handleStartGame","ApiRoomStart","state","lasteState","Battle"],"mappings":"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","sourcesContent":["import { Room } from './../../../../server/src/Biz/Room';\r\nimport { _decorator, Component, director, instantiate, Node, Prefab } from 'cc';\r\nimport { NetworkManager } from '../Global/NetworkManager';\r\nimport { ApiMsgEnum, IMsgRoom, IMsgRoomStart } from '../Common';\r\nimport { PlayerManager } from '../UI/PlayerManager';\r\nimport DataManager from '../Global/DataManager';\r\nimport EventManager from '../Global/EventManager';\r\nimport { EventEnum, SceneEnum } from '../Enum';\r\nimport { deepClone } from '../Utils';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('RoomManager')\r\nexport class RoomManager extends Component {\r\n    @property(Node)\r\n    PlayerList: Node = null;\r\n    @property(Prefab)\r\n    PlayerPrefab: Prefab = null\r\n    onLoad(): void {\r\n        NetworkManager.Instance.listenMsg(ApiMsgEnum.MsgRoomStart, this.handleStart, this)\r\n        NetworkManager.Instance.listenMsg(ApiMsgEnum.MsgRoom, this.renderPlayer, this)\r\n\r\n    }\r\n    start(): void {\r\n        this.renderPlayer(\r\n            { Room: DataManager.Instance.roomInfo }\r\n        )\r\n    }\r\n    protected onDestroy(): void {\r\n        NetworkManager.Instance.unListenMsg(ApiMsgEnum.MsgRoom, this.renderPlayer, this)\r\n        NetworkManager.Instance.unListenMsg(ApiMsgEnum.MsgRoomStart, this.handleStart, this)\r\n    }\r\n\r\n    renderPlayer({ Room: { players: Players } }: IMsgRoom) {\r\n        for (const c of this.PlayerList.children) {\r\n            c.active = false;\r\n        }\r\n\r\n\r\n        while (this.PlayerList.children.length < Players.length) {\r\n            const c = instantiate(this.PlayerPrefab);\r\n            c.active = false;\r\n            c.parent = this.PlayerList;\r\n        }\r\n\r\n        for (let i = 0; i < Players.length; i++) {\r\n            const data = Players[i];\r\n            const node = this.PlayerList.children[i]\r\n            node.getComponent(PlayerManager).init(data)\r\n        }\r\n\r\n    }\r\n\r\n    async handleLeaveRoom() {\r\n        const { success, error, res } = await NetworkManager.Instance.callApi(ApiMsgEnum.ApiRoomLeave, {});\r\n        if (!success) {\r\n            DataManager.Instance.roomInfo = null\r\n            console.log(\"退出房间成功\", res);\r\n            director.loadScene(SceneEnum.Hall)\r\n        } else {\r\n            console.log(\"退出房间失败\", error);\r\n        }\r\n    }\r\n    async handleStartGame() {\r\n        const { success, error, res } = await NetworkManager.Instance.callApi(ApiMsgEnum.ApiRoomStart, {});\r\n        if (!success) {\r\n            console.log(\"开始游戏成功\", res);\r\n        } else {\r\n            console.log(\"开始游戏失败\", error);\r\n        }\r\n    }\r\n    handleStart({ state }: IMsgRoomStart) {\r\n        DataManager.Instance.state = state;\r\n        DataManager.Instance.lasteState = deepClone(state)\r\n        director.loadScene(SceneEnum.Battle)\r\n    }\r\n}\r\n\r\n\r\n"]}