{"version":3,"sources":["file:///D:/CocosProject/cocos-nodejs-io-game-start-demo-master/apps/client/assets/Scripts/Entity/Weapon/WeaponManager.ts"],"names":["_decorator","UITransform","Vec2","DataManager","InputTypeEnum","EntityManager","EntityStateEnum","EventEnum","WeaponStateMachine","EventManager","ccclass","property","WeaponManager","body","anchor","point","owner","init","data","id","node","getChildByName","fsm","addComponent","weaponType","state","Idle","Instance","on","WeaponShoot","handleShoot","BulletBorn","handleBulletBorn","Attack","playerID","pointPos","worldPosition","stagePos","stage","getComponent","convertToNodeSpaceAR","anchorPos","direction","x","y","emit","ClientSync","type","position","normalize","console","log","bullets","onDestroy","off"],"mappings":"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","sourcesContent":["import { _decorator, director, Node, UITransform, Vec2 } from 'cc';\r\nimport DataManager from '../../Global/DataManager';\r\nimport { IActor, InputTypeEnum, toFix } from '../../Common';\r\nimport { EntityManager } from '../../Base/EntityManager';\r\nimport { EntityStateEnum, EventEnum, ParamsNameEnum, PrefabPathEnum } from '../../Enum';\r\nimport { WeaponStateMachine } from './WeaponStateMachine';\r\nimport EventManager from '../../Global/EventManager';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('WeaponManager')\r\n/** \r\n * @description 武器管理器 \r\n * \r\n*/\r\nexport class WeaponManager extends EntityManager {\r\n    private body: Node\r\n    private anchor: Node\r\n    private point: Node\r\n    private owner: number\r\n    /**\r\n     * @description 初始化武器信息\r\n     * @param data \r\n     */\r\n    init(data: IActor) {\r\n        this.owner = data.id;\r\n        this.body = this.node.getChildByName('Body');\r\n        this.anchor = this.body.getChildByName('Anchor');\r\n        this.point = this.anchor.getChildByName('Point');\r\n        this.fsm = this.body.addComponent(WeaponStateMachine);//添加状态机组件 多态\r\n        this.fsm.init(data.weaponType);//初始化状态机\r\n        this.state = EntityStateEnum.Idle;//设置初始状态\r\n        EventManager.Instance.on(EventEnum.WeaponShoot, this.handleShoot, this);\r\n        EventManager.Instance.on(EventEnum.BulletBorn, this.handleBulletBorn, this);\r\n    }\r\n    handleBulletBorn(owner: number) {\r\n        if (owner !== this.owner) return\r\n        this.state = EntityStateEnum.Attack;\r\n    }\r\n    handleShoot() {\r\n        if (this.owner !== DataManager.Instance.playerID) return;//不是当前玩家 不处理\r\n        //将point 的世界坐标位置转化到Stage节点坐标 对其生成位置\r\n        const pointPos = this.point.worldPosition;\r\n        const stagePos = DataManager.Instance.stage.getComponent(UITransform).convertToNodeSpaceAR(pointPos);\r\n        const anchorPos = this.anchor.worldPosition;\r\n        const direction = new Vec2(pointPos.x - anchorPos.x, pointPos.y - anchorPos.y);\r\n        EventManager.Instance.emit(EventEnum.ClientSync,\r\n            {\r\n                owner: this.owner,\r\n                type: InputTypeEnum.WeaponShoot,\r\n                position: {\r\n                    x: stagePos.x,\r\n                    y: stagePos.y\r\n                },\r\n                direction: direction.normalize(),\r\n            }\r\n        )\r\n        console.log(DataManager.Instance.state.bullets)\r\n    }\r\n    onDestroy(): void {\r\n        EventManager.Instance.off(EventEnum.WeaponShoot, this.handleShoot, this);\r\n        EventManager.Instance.off(EventEnum.BulletBorn, this.handleBulletBorn, this);\r\n    }\r\n}\r\n\r\n\r\n"]}