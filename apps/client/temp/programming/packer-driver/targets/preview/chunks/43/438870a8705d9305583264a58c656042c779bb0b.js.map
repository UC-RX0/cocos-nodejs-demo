{"version":3,"sources":["file:///D:/CocosProject/cocos-nodejs-io-game-start-demo-master/apps/client/assets/Scripts/Scene/BattleManager.ts"],"names":["_decorator","Component","instantiate","DataManager","JoyStickManager","BattleController","ActorManager","BulletManager","ApiMsgEnum","InputTypeEnum","ObjectPoolManager","NetworkManager","EventManager","EventEnum","deepClone","ccclass","property","BattleManager","stage","ui","_JoyStickData","pendingInputs","isFinish","start","clearGame","list","loadRes","Promise","all","connectServer","success","error","res","Instance","callApi","ApiPlayerJoin","nickname","console","log","initGame","node","getChildByName","destroyAllChildren","getComponentInChildren","setJoyStickData","initMap","on","ClientSync","handleClientSync","listenMsg","MsgServerSync","handleServerSync","onDestroy","off","unListenMsg","connect","catch","resolve","setTimeout","mapPrefab","map","addChild","update","dt","renderActor","renderBullet","tick","tickActor","data","state","actor","actorMap","get","id","renderActorData","prefab","am","addComponent","setActorManager","init","renderBulletData","bullet","bulletType","bm","setBulletManager","input","msg","frameId","frameID","sentMsg","MsgClientSync","type","ActorMove","applyInput","push","inputs","lastFrameId","lasteState","filter","item"],"mappings":"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","sourcesContent":["import { renderActorData } from './../Controller/BattleController';\r\nimport { _decorator, Component, EventTouch, input, Input, instantiate, Node, UITransform, Vec2, Vec3 } from 'cc';\r\nimport DataManager from '../Global/DataManager';\r\nimport { JoyStickManager } from '../UI/JoyStickManager';\r\nimport { BattleController } from '../Controller/BattleController';\r\nimport { ActorManager } from '../Entity/Actor/ActorManager';\r\nimport { BulletManager } from '../Entity/Bullet/BulletManager';\r\nimport { ApiMsgEnum, clientInput, EntityTypeEnum, IActor, IBullet, IMsgClientSync, IMsgServerSync, InputTypeEnum } from '../Common';\r\nimport ObjectPoolManager from '../Global/ObjectPoolManager';\r\nimport { NetworkManager } from '../Global/NetworkManager';\r\nimport EventManager from '../Global/EventManager';\r\nimport { EventEnum } from '../Enum';\r\nimport { deepClone } from '../Utils';\r\nconst { ccclass, property } = _decorator;\r\n\r\n@ccclass('BattleManager')\r\nexport class BattleManager extends Component {\r\n    private stage: Node = null;\r\n    private ui: Node = null;\r\n    private _JoyStickData: JoyStickManager = null;\r\n    private pendingInputs: IMsgClientSync[] = [];\r\n    private isFinish: boolean = false\r\n    async start() {\r\n        this.clearGame();\r\n        //网络模块\r\n        //游戏模块\r\n        const list = BattleController.loadRes();\r\n        await Promise.all([...list, this.connectServer()])\r\n        const { success, error, res } = await NetworkManager.Instance.callApi(ApiMsgEnum.ApiPlayerJoin, {\r\n            nickname: \"player1\"\r\n        });\r\n        if (!success) {\r\n            console.error(error);\r\n            return;\r\n        }\r\n        console.log('ApiPlayerJoin', res);\r\n        this.initGame();\r\n    }\r\n    clearGame() {\r\n        DataManager.Instance.stage = this.stage = this.node?.getChildByName(\"Stage\");\r\n        this.ui = this.node?.getChildByName(\"UI\");\r\n        this.stage.destroyAllChildren();\r\n    }\r\n    initGame() {\r\n        this._JoyStickData = this.ui.getComponentInChildren(JoyStickManager);\r\n        BattleController.setJoyStickData(this._JoyStickData);\r\n        this.initMap();\r\n        this.isFinish = true;\r\n        EventManager.Instance.on(EventEnum.ClientSync, this.handleClientSync, this);\r\n        NetworkManager.Instance.listenMsg(ApiMsgEnum.MsgServerSync, this.handleServerSync, this);\r\n    }\r\n\r\n    onDestroy(): void {\r\n        EventManager.Instance.off(EventEnum.ClientSync, this.handleClientSync, this);\r\n        NetworkManager.Instance.unListenMsg(ApiMsgEnum.MsgServerSync, this.handleServerSync, this);\r\n    }\r\n\r\n    async connectServer() {\r\n        //连接服务器\r\n        if (!(await NetworkManager.Instance.connect().catch(() => false))) {\r\n            await new Promise((resolve) => setTimeout(resolve, 1000));//等待1秒\r\n            await this.connectServer();\r\n        }\r\n    }\r\n    initMap() {\r\n        //地图初始化\r\n        const mapPrefab = BattleController.initMap();\r\n        const map = instantiate(mapPrefab);\r\n        this.stage.addChild(map);\r\n    }\r\n    update(dt: number): void {\r\n        if (!this.isFinish) return;\r\n        this.renderActor();\r\n        this.renderBullet();\r\n        this.tick(dt);\r\n    }\r\n    tick(dt: number) {\r\n        this.tickActor(dt);\r\n        // DataManager.Instance.applyInput({\r\n        //     type: InputTypeEnum.TimePast,\r\n        //     dt\r\n        // });\r\n    }\r\n    /**\r\n     * @description 从state中获取已经在游戏中的玩家信息,然后触发他们的tick(更新玩家信息)\r\n     * @param dt \r\n     */\r\n    tickActor(dt: number) {\r\n        for (const data of DataManager.Instance.state.actor) {\r\n            const actor = DataManager.Instance.actorMap.get(data.id);\r\n            if (actor) {\r\n                actor.tick(dt);\r\n            }\r\n        }\r\n    }\r\n    renderActor() {\r\n        const renderActorData = BattleController.renderActor();\r\n        // const renderBulletData = BattleController.renderBullet();\r\n        //如若为空，代表actorMap已经存在键值对(代表已经存在了该actor),则由Controller直接触发渲染,不需要Manager渲染\r\n        if (!renderActorData) return;\r\n        const { data, prefab } = renderActorData;\r\n        const actor = instantiate(prefab);\r\n        this.stage.addChild(actor);\r\n        const am = actor.addComponent(ActorManager);\r\n        BattleController.setActorManager(data.id, am);\r\n        am.init(data);\r\n        // console.log('here1');\r\n\r\n    }\r\n    /**\r\n * @description 渲染游戏中所有子弹的方法\r\n * 负责子弹的创建、初始化和状态更新\r\n */\r\n    renderBullet() {\r\n        const renderBulletData = BattleController.renderBullet();\r\n        // 如果为空，代表bulletMap已经存在键值对(代表已经存在了该bullet),则由Controller直接触发渲染,不需要Manager渲染\r\n        if (!renderBulletData) return;\r\n        const { data } = renderBulletData;\r\n        const bullet = ObjectPoolManager.Instance.get(data.bulletType)\r\n        const bm = bullet.addComponent(BulletManager);\r\n        BattleController.setBulletManager(data.id, bm);\r\n        bm.init(data);\r\n    }\r\n    /**\r\n     * @description 处理服务器同步的actor数据\r\n     * @param data 服务器同步的actor数据\r\n     */\r\n    handleClientSync(input: clientInput) {\r\n        const msg = {\r\n            input,\r\n            frameId: DataManager.Instance.frameID++,\r\n        }\r\n        NetworkManager.Instance.sentMsg(ApiMsgEnum.MsgClientSync, msg);\r\n        if (input.type === InputTypeEnum.ActorMove) {\r\n            DataManager.Instance.applyInput(input);\r\n            this.pendingInputs.push(msg);\r\n        }\r\n    }\r\n    handleServerSync({ inputs, lastFrameId }: IMsgServerSync) {\r\n        DataManager.Instance.state = DataManager.Instance.lasteState;\r\n        for (const input of inputs) {\r\n            // 应用服务器输入 有Bug 移动出现问题\r\n            DataManager.Instance.applyInput(input);\r\n        }\r\n        DataManager.Instance.lasteState = deepClone(DataManager.Instance.state);\r\n        this.pendingInputs = this.pendingInputs.filter((item) => item.frameId > lastFrameId);\r\n        for (const item of this.pendingInputs) {\r\n            DataManager.Instance.applyInput(item.input);\r\n        }\r\n    }\r\n}\r\n\r\n"]}